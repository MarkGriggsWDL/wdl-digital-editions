name: Build latest teaser image

on:
  push:
    paths:
      - 'editions/latest.pdf'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: editions-pipeline
  cancel-in-progress: false

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # If you ever move PDFs to Git LFS, set: lfs: true

      - name: Sanity-check latest.pdf
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking editions/latest.pdf …"
          test -f editions/latest.pdf || { echo "latest.pdf missing"; exit 1; }
          ls -lh editions/latest.pdf
          SIZE=$(stat -c%s editions/latest.pdf)
          if [ "${SIZE}" -lt 100000 ]; then
            echo "latest.pdf too small (${SIZE} bytes) — not a valid PDF. Aborting."; exit 1
          fi
          echo "File type: $(file -b editions/latest.pdf)"

      - name: Install poppler (pdftoppm) + jpegoptim
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y poppler-utils jpegoptim

      - name: Render first page to JPG(s) in /tmp
        shell: bash
        run: |
          set -e
          echo "Rendering from editions/latest.pdf…"
          # Always use /tmp targets to avoid mv-to-self mistakes
          pdftoppm -jpeg -singlefile -f 1 -l 1 -scale-to 1200 editions/latest.pdf /tmp/latest-teaser-1200
          test -f /tmp/latest-teaser-1200.jpg

          pdftoppm -jpeg -singlefile -f 1 -l 1 -scale-to 2000 editions/latest.pdf /tmp/latest-teaser-2000
          test -f /tmp/latest-teaser-2000.jpg

          jpegoptim --strip-all --max=82 /tmp/latest-teaser-1200.jpg
          jpegoptim --strip-all --max=82 /tmp/latest-teaser-2000.jpg

          mv -f /tmp/latest-teaser-1200.jpg editions/latest-teaser-1200.jpg
          mv -f /tmp/latest-teaser-2000.jpg editions/latest-teaser-2000.jpg

          echo "Final files:"
          ls -lh editions/latest-teaser-*.jpg

      - name: Build manifest (latest.json)
        id: manifest
        shell: bash
        run: |
          set -e
          VER=$(sha1sum editions/latest-teaser-1200.jpg | awk '{print $1}' | cut -c1-8)
          UPDATED=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > editions/latest.json <<EOF
          {
            "updated": "${UPDATED}",
            "version": "${VER}",
            "alt": "Wellington & District Leader — latest issue cover",
            "teaser": {
              "1200": "https://softedgesmusic.github.io/wdl-digital-editions/editions/latest-teaser-1200.jpg?v=${VER}",
              "2000": "https://softedgesmusic.github.io/wdl-digital-editions/editions/latest-teaser-2000.jpg?v=${VER}"
            }
          }
          EOF
          echo "Wrote editions/latest.json:"
          cat editions/latest.json

      - name: Commit teaser + manifest (rebase-safe)
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add editions/latest-teaser-1200.jpg \
                  editions/latest-teaser-2000.jpg \
                  editions/latest.json

          if git diff --cached --quiet; then
            echo "Nothing to commit."
            exit 0
          fi

          git fetch origin main
          git pull --rebase origin main
          git commit -m "Auto-generate latest front-page teaser JPGs + manifest"
          git push origin HEAD:main
