name: Build latest teaser (single JPG)

on:
  push:
    paths:
      - 'editions/latest.pdf'          # run whenever latest.pdf changes
  workflow_dispatch:                   # allow manual runs from Actions tab

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install poppler (pdftoppm) + jpegoptim
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y poppler-utils jpegoptim

      - name: Sanity-check latest.pdf
        run: |
          set -euo pipefail
          echo "Checking editions/latest.pdf …"
          test -f editions/latest.pdf || { echo "❌ editions/latest.pdf not found"; exit 1; }
          ls -lh editions/latest.pdf
          # guard against zero-byte or truncated files
          BYTES=$(stat -c%s editions/latest.pdf || stat -f%z editions/latest.pdf || echo 0)
          if [ "$BYTES" -lt 10000 ]; then
            echo "❌ latest.pdf too small ($BYTES bytes) — not a valid PDF. Aborting."
            exit 1
          fi

      - name: Render first page @ 2000px JPG (single file)
        run: |
          set -euo pipefail
          echo "Rendering 2000px JPG…"
          # outputs editions/latest-teaser.jpg
          pdftoppm \
            -jpeg \
            -singlefile \
            -f 1 -l 1 \
            -scale-to 2000 \
            editions/latest.pdf editions/latest-teaser
          test -f editions/latest-teaser.jpg
          ls -lh editions/latest-teaser.jpg

      - name: Optimise JPG
        run: |
          set -euo pipefail
          jpegoptim --strip-all --max=85 editions/latest-teaser.jpg || true
          echo "Optimised file:"
          ls -lh editions/latest-teaser.jpg

      - name: Build manifest (latest.json)
        id: manifest
        run: |
          set -euo pipefail
          VER=$(sha1sum editions/latest-teaser.jpg | awk '{print $1}' | cut -c1-8)
          UPDATED=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > editions/latest.json <<EOF
          {
            "updated": "${UPDATED}",
            "version": "${VER}",
            "alt": "Wellington & District Leader — latest issue cover",
            "teaser": "https://softedgesmusic.github.io/wdl-digital-editions/editions/latest-teaser.jpg?v=${VER}"
          }
          EOF
          echo "Wrote editions/latest.json:"
          cat editions/latest.json

      - name: Rebase-safe commit & push teaser + manifest
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add editions/latest-teaser.jpg editions/latest.json || true

          # If nothing changed, exit cleanly
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Auto-generate latest teaser (2000px JPG) + manifest"

          # Rebase-safe push to avoid non-fast-forward errors
          git fetch origin main
          git pull --rebase origin main || true
          git push origin HEAD:main
