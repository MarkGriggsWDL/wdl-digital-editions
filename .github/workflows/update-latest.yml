name: Update latest.pdf from new issue

on:
  push:
    paths:
      - 'editions/*.pdf'          # any PDF…
    paths-ignore:
      - 'editions/latest.pdf'     # …but NOT latest.pdf (prevents self-trigger loops)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: wdl-update-latest
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Copy newest issue → editions/latest.pdf
        shell: bash
        run: |
          set -euo pipefail

          # Find newest PDF EXCLUDING editions/latest.pdf
          # (GNU find on ubuntu supports -printf)
          mapfile -t files < <(find editions -maxdepth 1 -type f -name '*.pdf' ! -name 'latest.pdf' -printf '%T@ %p\n' | sort -nr | awk '{print $2}')

          if [ ${#files[@]} -eq 0 ]; then
            echo "No source PDFs found under editions/ (excluding latest.pdf). Nothing to do."
            exit 0
          fi

          NEWEST="${files[0]}"
          echo "Newest source PDF: ${NEWEST}"

          echo "Copying to editions/latest.pdf …"
          cp -f "${NEWEST}" editions/latest.pdf
          ls -lh editions/latest.pdf

          BYTES=$(wc -c < editions/latest.pdf || echo 0)
          if [ "${BYTES}" -lt 10240 ]; then
            echo "latest.pdf too small (${BYTES} bytes) — aborting."
            exit 1
          fi

          # Sidecar to force a commit (and to record provenance)
          basename "${NEWEST}" > editions/latest.source.txt
          echo "Source recorded in editions/latest.source.txt:"
          cat editions/latest.source.txt

      - name: Commit (conflict-free) and push atop origin/main
        shell: bash
        env:
          GH_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          GH_NAME:  "github-actions[bot]"
        run: |
          set -euo pipefail
          git config user.email "$GH_EMAIL"
          git config user.name  "$GH_NAME"

          git add editions/latest.pdf editions/latest.source.txt

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git fetch origin main
          git reset --soft origin/main
          git commit -m "Update latest.pdf from $(cat editions/latest.source.txt)"
          git push origin HEAD:main
